<!DOCTYPE html>
<html>

<head>
    <title>Load Data API Test</title>
</head>

<body>
    <h1>Load Data API Test</h1>
    <button onclick="testAPI()">Test API Response</button>
    <div id="output" style="margin-top: 20px;"></div>

    <script>
        async function testAPI() {
            const plantId = '65f20fa1-047a-4379-8464-59f1d94be3c7';
            const date = '2025-06-12';

            document.getElementById('output').innerHTML = '<p>Loading...</p>';

            try {
                const response = await fetch(`/plants/${plantId}/chart-data?date=${date}`);
                const data = await response.json();

                console.log('=== FULL API RESPONSE ===');
                console.log(data);

                let output = '<h2>API Response Analysis</h2>';

                // Check energy_chart data
                if (data.energy_chart) {
                    const energyEntries = Object.entries(data.energy_chart).slice(0, 5); // First 5 entries
                    output += '<h3>Energy Chart Data (first 5 entries):</h3>';
                    output += '<table border="1" style="border-collapse: collapse;">';
                    output += '<tr><th>Timestamp</th><th>PV (W)</th><th>Battery (W)</th><th>Grid (W)</th><th>Load (W)</th></tr>';

                    energyEntries.forEach(([timestamp, values]) => {
                        output += `<tr>`;
                        output += `<td>${timestamp}</td>`;
                        output += `<td>${values.pv_p || 0}</td>`;
                        output += `<td>${values.battery_p || 0}</td>`;
                        output += `<td>${values.grid_p || 0}</td>`;
                        output += `<td style="background-color: ${values.load_p !== 0 ? 'lightgreen' : 'pink'};">${values.load_p || 0}</td>`;
                        output += `</tr>`;
                    });
                    output += '</table>';

                    // Calculate statistics
                    const allLoadValues = Object.values(data.energy_chart).map(entry => entry.load_p || 0);
                    const nonZeroLoadValues = allLoadValues.filter(val => val !== 0);

                    output += '<h3>Load Data Statistics:</h3>';
                    output += `<p>Total entries: ${allLoadValues.length}</p>`;
                    output += `<p>Non-zero load entries: ${nonZeroLoadValues.length}</p>`;
                    output += `<p>Min load: ${Math.min(...allLoadValues)}W</p>`;
                    output += `<p>Max load: ${Math.max(...allLoadValues)}W</p>`;
                    output += `<p>Average load: ${(allLoadValues.reduce((a, b) => a + b, 0) / allLoadValues.length).toFixed(2)}W</p>`;
                } else {
                    output += '<p>No energy_chart data found!</p>';
                }

                // Check battery_price data  
                if (data.battery_price) {
                    const batteryEntries = Object.entries(data.battery_price).slice(0, 3);
                    output += '<h3>Battery Price Data (first 3 entries):</h3>';
                    output += '<table border="1" style="border-collapse: collapse;">';
                    output += '<tr><th>Timestamp</th><th>Battery (W)</th><th>Load (W)</th><th>Price</th></tr>';

                    batteryEntries.forEach(([timestamp, values]) => {
                        output += `<tr>`;
                        output += `<td>${timestamp}</td>`;
                        output += `<td>${values.battery_p || 0}</td>`;
                        output += `<td style="background-color: ${values.load_p !== 0 ? 'lightgreen' : 'pink'};">${values.load_p || 0}</td>`;
                        output += `<td>${values.price || 0}</td>`;
                        output += `</tr>`;
                    });
                    output += '</table>';
                }

                document.getElementById('output').innerHTML = output;

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
            }
        }
    </script>
</body>

</html>