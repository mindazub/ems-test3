<!DOCTYPE html>
<html>

<head>
    <title>CSV Download Test</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body>
    <h2>CSV Download Test</h2>

    <div>
        <h3>Test CSV Download (Direct)</h3>
        <a href="{{ route('plants.download', ['plant' => '65f20fa1-047a-4379-8464-59f1d94be3c7', 'chart' => 'energy', 'type' => 'csv']) }}?date=2024-06-10"
            class="btn">Download Energy CSV</a>
    </div>

    <div style="margin-top: 20px;">
        <h3>Test CSV Download (AJAX)</h3>
        <button onclick="downloadCSVAjax()">Download Energy CSV (AJAX)</button>
    </div>

    <div style="margin-top: 20px;">
        <h3>Test PDF Download (Direct)</h3>
        <a href="{{ route('plants.download', ['plant' => '65f20fa1-047a-4379-8464-59f1d94be3c7', 'chart' => 'energy', 'type' => 'pdf']) }}?date=2024-06-10"
            class="btn">Download Energy PDF</a>
    </div>

    <div style="margin-top: 20px;">
        <h3>Debug Info</h3>
        <div id="debug"></div>
    </div>

    <script>
        function downloadCSVAjax() {
            const plantId = '65f20fa1-047a-4379-8464-59f1d94be3c7';
            const chart = 'energy';
            const selectedDate = '2024-06-10';

            const url = `/plants/${plantId}/download/${chart}/csv?date=${selectedDate}`;

            document.getElementById('debug').innerHTML = `
                <p><strong>URL:</strong> ${url}</p>
                <p><strong>Plant ID:</strong> ${plantId}</p>
                <p><strong>Chart:</strong> ${chart}</p>
                <p><strong>Date:</strong> ${selectedDate}</p>
                <p><strong>Status:</strong> Making request...</p>
            `;

            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'text/csv',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                }
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);

                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `plant_${plantId}_${chart}_${selectedDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);

                    document.getElementById('debug').innerHTML += `
                    <p><strong>Status:</strong> Download successful!</p>
                `;
                })
                .catch(error => {
                    console.error('Download failed:', error);
                    document.getElementById('debug').innerHTML += `
                    <p><strong>Status:</strong> Download failed - ${error.message}</p>
                `;
                });
        }
    </script>

    <style>
        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        div {
            margin-bottom: 15px;
        }
    </style>
</body>

</html>